<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>
<body>
<script>
(function(){
  // 观察者模式实现
  function DownloadTask(id) {
    this.id = id;
    this.loaded = false;
    this.url = null;
  }
  DownloadTask.prototype.finish = function(url) {
    this.loaded = true;
    this.url = url;
    console.log('Task' + this.id + ' load data from ' + url);
  }
  function DownloadTaskList() {
    this.downloadTaskList = [];
  }
  DownloadTaskList.prototype.getCount = function() {
    return this.downloadTaskList.length;
  }
  DownloadTaskList.prototype.get = function(index) {
    return this.downloadTaskList[index];
  }
  DownloadTaskList.prototype.add = function(obj) {
    return this.downloadTaskList.push(obj);
  }
  DownloadTaskList.prototype.remove = function(obj) {
    const downloadTaskCount = this.downloadTasks.getCount();
    while(i < downloadTaskCount) {
      if (this.downloadTaskList[i] === obj) {
        this.downloadTaskList.splice(i,1);
        break;
      }
    }
  }
  function DataHub () {
    this.downloadTasks = new DownloadTaskList();
  }
  DataHub.prototype.addDownloadTask = function(downloadTask) {
    this.downloadTasks.add(downloadTask);
  }
  DataHub.prototype.removeDownloadTask = function(downloadTask) {
    this.downloadTasks.remove(downloadTask);
  };
  DataHub.prototype.notify = function(url) {
    const downloadTaskCount = this.downloadTasks.getCount();
    for (var i = 0; i < downloadTaskCount; i++) {
      this.downloadTasks.get(i).finish(url);
    }
  };
  var dataHub = new DataHub();
  var downloadTask1 = new DownloadTask(1);
  var downloadTask2 = new DownloadTask(2);
  dataHub.addDownloadTask(downloadTask1);
  dataHub.addDownloadTask(downloadTask2);
  // dataHub.removeDownloadTask(downloadTask2);
  dataHub.notify('http://mi.com')
})();
(function(){
  // 发布订阅模式实现
  function DataHub() {}
  DataHub.prototype.notify = function(url, callback) {
    callback(url);
  }
  function DownloadManager() {
    this.events = {};
    this.uId = -1;
  }
  Downloadmanager.prototype.publish = function(eventType, url) {
    if (!this.events[eventType]) {
      return false;
    }
    var subscribers = this.events[eventType],
      count = subscribers ? subscribers.length : 0;
    while (count --) {
      var subscribers = subscribers[count];
      subscriber.handler(eventType, subscriber.taskId, url);
    }
  }
  DownloadManager.prototype.subscribe = function(eventType, handler) {
    if (!this.events[eventType]) {
      this.events[eventType] = [];
    }
    var taskId = (++this.uId).toString();
    this.events[eventType].push({
      taskId: taskId,
      handler: handler
    });
    
    return taskId;
  }

  var dataHub = new DataHub();
  var downloadManager = new DownloadManager();
  var dataLoader = function(eventType, taskId, url) {
    console.log('Task' + taskId + 'load data from' + url);
  }
  var downloadTask1 = downloadManager.subscribe('dataReady', dataLoader);
  dataHub.notify('http://mi.com', function(url){
    downloadManager.publish('dataReady', url);
  });
})()
</script>
</body>
</html>